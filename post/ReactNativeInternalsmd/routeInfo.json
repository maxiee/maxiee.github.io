{"template":"/home/maxiee/Code/Blog/maxiee.github.io/src/pages/post","sharedHashesByProp":{},"data":{"post":{"name":"React Native Internalsï¼ˆç¿»è¯‘ï¼‰","desc":"React Native çœ‹èµ·æ¥åƒæ˜¯é»‘é­”æ³•ï¼Œä¸ºäº†ç†è§£å…¶ä¸­åŸç†ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ React Native çš„æ¶æ„ä¸å†…éƒ¨å·¥ä½œæ–¹å¼ã€‚","type":"md","link":"ReactNativeInternalsmd","create":"2019-03-07","filename":"ReactNativeInternals.md"},"content":"## å‰è¨€\n\næœ¬æ–‡æºé“¾æ¥ä¸º [React Native Internals](https://www.reactnative.guide/3-react-native-internals/3.1-react-native-internals.html)ï¼Œæˆ‘å°†å…¶ç¿»è¯‘ä¸ºä¸­æ–‡ã€‚\n\nReact Native æ˜¯ä¸€ä¸ªå…è®¸å¼€å‘è€…ä½¿ç”¨ JavaScript æ„å»ºåŸç”Ÿåº”ç”¨çš„æ¡†æ¶ã€‚\n\nç­‰ç­‰ï¼Cordova ä¸æ˜¯å¾ˆæ—©å°±è¿™ä¹ˆåšäº†å—ã€‚ä¸ºå•¥è¦ç”¨RNï¼Œ æœ‰å•¥ç‰¹åˆ«çš„ï¼Ÿ\n\nRN ä¸åŸºäº Cordova çš„åº”ç”¨çš„ä¸»è¦å·®åˆ«åœ¨äºï¼š\n\n- åŸºäº Cordova çš„åº”ç”¨è¿è¡Œåœ¨ WebView ä¸­\n- RN åˆ™ç›´æ¥è®¿é—®ç§»åŠ¨æ“ä½œç³»ç»Ÿæä¾›çš„åŸç”Ÿ API å’Œ View\n- å› æ­¤ï¼ŒRN åº”ç”¨æ‹¥æœ‰ä¸åŸç”Ÿåº”ç”¨ä¸€è‡´çš„ä½“éªŒä¸æ€§èƒ½\n\né¦–å…ˆï¼Œç›´è§‚ä¼šè®¾æƒ³çš„æ˜¯ React Native å°† JS ä»£ç ç¼–è¯‘åˆ°å¯¹åº”çš„åŸç”Ÿä»£ç ã€‚\n\nä½†æ˜¯è¿™å¾ˆéš¾å®ç°ï¼Œå› ä¸º Java å’Œ Objective C éƒ½æ˜¯å¼ºç±»å‹è¯­è¨€ï¼Œè€Œ JavaScript æ˜¯å¼±ç±»å‹çš„ã€‚\n\nReact Native æ²¡æœ‰è¿™ä¹ˆåšï¼Œè€Œæ˜¯é€šè¿‡ä¸€ç§æ›´èªæ˜çš„æ–¹å¼ã€‚\n\nä»æœ¬è´¨ä¸Šï¼ŒReact Native å¯ä»¥çœ‹åšæ˜¯ä¸€ç»„ React ç»„ä»¶ï¼Œå…¶ä¸­æ¯ä¸ªç»„ä»¶å¯¹åº”äºç›¸åº”çš„è§†å›¾å’Œç»„ä»¶ã€‚\n\nä¾‹å¦‚ï¼Œä¸€ä¸ªåŸç”Ÿçš„ TextInput ä¼šæœ‰ä¸€ä¸ª RN ç»„ä»¶ä¸ä¹‹å¯¹åº”ï¼Œå¯ä»¥åœ¨ JS ä¸­ç›´æ¥å¯¼å…¥ï¼Œå°±åƒä½¿ç”¨æ™®é€š React ç»„ä»¶ä¸€æ ·ã€‚\n\nå› æ­¤ï¼Œå¼€å‘è€…å¯ä»¥å‘å¼€å‘æ™®é€š React Web APP é‚£æ ·æ¥å¼€å‘åŸç”Ÿåº”ç”¨ã€‚\n\nå¥½å§ï¼Œè¿™çœ‹èµ·æ¥åƒæ˜¯é»‘é­”æ³• ğŸ™„ã€‚\n\nä¸ºäº†ç†è§£å…¶ä¸­åŸç†ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ React Native çš„æ¶æ„ä¸å†…éƒ¨å·¥ä½œæ–¹å¼ã€‚\n\n## æ¶æ„ ğŸ¤–\n\niOS ä¸ Android çš„æ¶æ„æ˜¯ç±»ä¼¼çš„ï¼Œä½†æ˜¯æœ‰ç»†å¾®å·®å¼‚ã€‚\n\nå¦‚æœæˆ‘ä»¬ä»æ•´ä½“æ¥çœ‹ï¼ŒRN å¹³å°ä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š\n\n1. **Native Code/Modules**ï¼š\n    - å¤§å¤šæ•°åŸç”Ÿä»£ç åœ¨ iOS ä½¿ç”¨ Objective C æˆ– Swift ç¼–å†™ï¼Œåœ¨ Android ä½¿ç”¨ Java ç¼–å†™\n    - ä½†æ˜¯å¯¹äºå†™ React Native APP æ¥è¯´ï¼Œæˆ‘ä»¬å¯èƒ½éƒ½ä¸éœ€è¦å†™ iOS æˆ– Android çš„åŸç”Ÿä»£ç \n\n2. **Javascript VM**ï¼š\n\n    - æˆ‘ä»¬çš„ JavaScript ä»£ç ç”± JS è™šæ‹Ÿæœºè¿è¡Œ\n    - React Native ä½¿ç”¨ JavaScriptCore è¿è¡Œ iOS/Android è™šæ‹Ÿæœºå’Œè®¾å¤‡ä¸­çš„ä»£ç ï¼ŒJavaScriptCore ä¹Ÿæ˜¯é©±åŠ¨ Safari çš„ JavaScript å¼•æ“\n    - JavaScriptCore æ˜¯ä¸€ä¸ªå¼€æºçš„ JavaScript å¼•æ“ï¼Œæœ€åˆæ˜¯ä¸º WebKit å¼€å‘çš„\n    - åœ¨ iOS å¹³å°ä¸Šï¼ŒReact Native ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ JavaScriptCoreã€‚å®ƒæœ€åˆæ˜¯ä¸ OS X Mavericks ä¸€èµ·è¢«å¼•å…¥iOS 7 çš„ã€‚https://developer.apple.com/reference/javascriptcore\n    - åœ¨ Android å¹³å°ï¼Œåº”ç”¨ä¼šæŠŠ JavaScriptCore æ‰“åŒ…åœ¨å†…ã€‚è¿™å›å¢å¤§åŒ…ä½“ç§¯ã€‚å› æ­¤ä¸€ä¸ª RN çš„ HelloWord åº”ç”¨ï¼Œåœ¨ Android ä¸Šä¹Ÿå¾— 3~4 MB\n    - åœ¨ Chrome Debug æ¨¡å¼çš„æ—¶å€™ï¼ŒJavaScript ä»£ç ä¼šåœ¨ Chrome ä¸­è¿è¡Œï¼ˆè€Œä¸æ˜¯è®¾å¤‡ä¸Šçš„ JavaScriptCoreï¼‰ï¼Œå¹¶ä¸”é€šè¿‡ WebSocket ä¸åŸç”Ÿä»£ç é€šä¿¡ã€‚å› æ­¤è¿™ä¼šä½¿ç”¨ V8 å¼•æ“ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½ä½¿ç”¨ Crhome çš„è°ƒè¯•å·¥å…·çœ‹åˆ°è®¸å¤šä¿¡æ¯ï¼Œæ¯”å¦‚ç½‘ç»œè¯·æ±‚ï¼Œå‘½ä»¤è¡Œæ—¥å¿—ç­‰ç­‰ã€‚ğŸ˜\n\n3. **React Native Bridge**ï¼šReact Native Bridge æ˜¯ C++/Java bridgeï¼Œè´Ÿè´£ Native çº¿ç¨‹ä¸ Java çº¿ç¨‹é—´çš„é€šä¿¡ã€‚ä½¿ç”¨å®šåˆ¶çš„åè®®ä¼ é€’æ¶ˆæ¯ã€‚\n\n    ![](image/ReactNativeInternals1.png)\n\n    åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¼€å‘è€…ä¼šä½¿ç”¨ JavaScript æ¥ç¼–å†™æ•´ä¸ªåº”ç”¨ã€‚\n\n    é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¡Œè¯­å¥æ¥è¿è¡Œç¨‹åºï¼š\n\n    ```\n    react-native run-ios\n    \n    react-native run-android\n    ```\n\n    æ­¤æ—¶ï¼ŒReact Native Cli ä¼šåˆ›å»ºä¸€ä¸ª node æ‰“åŒ…å™¨ï¼ˆmetro bundlerï¼‰ï¼Œå®ƒä¼šå°†  JS ä»£ç æ‰“åŒ…ä¸ºä¸€ä¸ªå•ä¸ªçš„ main.bundle.js æ–‡ä»¶ã€‚\n\n    è¿™ä¸ªæ‰“åŒ…å™¨å¯ä»¥è¢«çœ‹åšæ˜¯ç±»ä¼¼ Webpackã€‚\n\n    ç°åœ¨ï¼Œå½“ React Native åº”ç”¨è¢«å¯åŠ¨æ—¶ï¼Œé¦–å…ˆè¢«åŠ è½½çš„æ˜¯åŸç”Ÿå…¥å£ç‚¹ï¼ˆnative entry pointï¼‰ã€‚\n\n    Native çº¿ç¨‹ä¼šåˆ›å»º JS VM çº¿ç¨‹ï¼Œå¹¶è¿è¡Œæ‰“åŒ…åçš„ JS ä»£ç ã€‚JS ä»£ç ä¸­åŒ…å«åº”ç”¨çš„æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ã€‚\n\n    Native çº¿ç¨‹ç°åœ¨é€šè¿‡ RN Bridge å‘é€æ¶ˆæ¯ï¼Œæ¥å¯åŠ¨ JS åº”ç”¨ã€‚\n\n    æŒ‡ä»¤åŒ…æ‹¬åŠ è½½å“ªäº›è§†å›¾ï¼Œä»ç¡¬ä»¶ä¸­è·å–å“ªäº›ä¿¡æ¯ç­‰ç­‰ã€‚\n\n    ä¾‹å¦‚ï¼Œå¦‚æœ JS çº¿ç¨‹æƒ³è¦åˆ›å»ºä¸€ä¸ª VIew å’Œ Textï¼Œå®ƒä¼šå°†è¯·æ±‚æ‰“åŒ…ä¸ºä¸€ä¸ªå•æ¡çš„æ¶ˆæ¯ï¼Œå‘é€åˆ° Native çº¿ç¨‹å¹¶è¿›è¡Œå®é™…å±•ç¤ºã€‚\n\n    ```\n    [ [2,3,[2,'Text',{...}]] [2,3,[3,'View',{...}]] ]\n    ```\n\n    Native çº¿ç¨‹ä¼šå¤„ç†è¿™äº›æ“ä½œï¼Œå¹¶å°†ç»“æœè¿”å›ç»™ JSï¼Œä»¥ç¡®ä¿æ“ä½œå·²è¢«å®Œæˆæ‰§è¡Œã€‚\n\n    **æ³¨æ„ï¼š**å¦‚æœæƒ³åœ¨ Console ä¸­æŸ¥çœ‹ bridge æ¶ˆæ¯ï¼Œåªéœ€è¦åœ¨ `index.<platform>.js` ä¸­åŠ å…¥ä»¥ä¸‹ä»£ç ï¼š\n\n    ```js\n    import MessageQueue from 'react-native/Libraries/BatchedBridge/MessageQueue';\n    MessageQueue.spy(true);\n    ```\n\n## çº¿ç¨‹æ¨¡å‹ ğŸš§\n\nå½“ React Native åº”ç”¨è¢«å¯åŠ¨æ—¶ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸‹çº¿ç¨‹é˜Ÿåˆ—ï¼š\n\n1. **Main thread** *ï¼ˆNative Queueï¼‰*ï¼š\n    - è¿™æ˜¯åº”ç”¨å¯åŠ¨æ—¶å°±ç«‹åˆ»åˆ›å»ºçš„ä¸»çº¿ç¨‹\n    - å®ƒåŠ è½½ APP å¹¶å¯åŠ¨ JS çº¿ç¨‹æ¥æ‰§è¡Œ JavaScript ä»£ç \n    - Native çº¿ç¨‹è¿˜ç›‘å¬ UI äº‹ä»¶ï¼Œä¾‹å¦‚â€æŒ‰ä¸‹â€œã€â€è§¦æ‘¸â€œç­‰ç­‰ã€‚è¿™äº›äº‹ä»¶ä¼šé€šè¿‡ RN Bridge è¢«ä¼ é€’åˆ° JS çº¿ç¨‹\n    - ä¸€æ—¦ JavaScript åŠ è½½èµ·æ¥ï¼ŒJS çº¿ç¨‹ä¼šé€šè¿‡æ¶ˆæ¯æ–¹å¼å‘é€å±å¹•ä¸Šè¦å±•ç¤ºçš„å†…å®¹\n    - è¿™ä¸ªä¿¡æ¯è¢« **shadow node thread** ä½¿ç”¨ï¼Œæ¥è®¡ç®—å¸ƒå±€\n    - shadow thread ä»æ ¹æœ¬ä¸Šè¯´æ˜¯ä¸€ä¸ªæ•°å­¦å¼•æ“ï¼Œæ¥æœ€ç»ˆå†³å®šè§†å›¾çš„ä½ç½®è¯¥å¦‚ä½•è®¡ç®—\n    - è¿™äº›æŒ‡ä»¤æœ€ç»ˆä¼ å›ä¸»çº¿ç¨‹ï¼Œå¹¶è¿›è¡Œå®é™…å±•ç¤º\n2. **Javascript thread** *(JS Queue)* ï¼š\n    - JavaScript çº¿ç¨‹é˜Ÿåˆ—æ˜¯ä¸» JS åŒ…è¢«æ‰§è¡Œçš„çº¿ç¨‹\n    - JS çº¿ç¨‹æ‰§è¡Œæ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç¼–å†™çš„ React Native ä¸šåŠ¡ä»£ç \n3. **Custom Native Modules**\n    - é™¤äº† React Native åˆ›å»ºçš„çº¿ç¨‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨è‡ªå·±åˆ›å»ºçš„è‡ªå®šä¹‰æ¨¡å—ä¸­åˆ›å»ºçº¿ç¨‹ï¼Œä»¥åŠ å¿«åº”ç”¨ç¨‹åºçš„æ€§èƒ½\n    - ä¾‹å¦‚ï¼šåŠ¨ç”»åœ¨ React Native ä¸­äº¤ç”±ä¸€ä¸ªå•ç‹¬çš„ native çº¿ç¨‹æ¥å¤„ç†ï¼Œä»¥åˆ†æ‹… JS çº¿ç¨‹çš„å·¥ä½œ\n\né“¾æ¥ï¼šhttps://www.youtube.com/watch?v=0MlT74erp60\n\n## View Managers ğŸ‘“\n\nView Managers æ˜¯ Native Moduleï¼Œå®ƒå°† JSX è§†å›¾æ˜ å°„åˆ° Native Viewsã€‚ä¾‹å¦‚ï¼š\n\n```jsx\nimport React, { Component } from \"react\";\nimport { Text, View, AppRegistry } from \"react-native\";\n\nclass HelloWorldApp extends Component {\n  render() {\n    return (\n      <View style={{ padding: 40 }}>\n        <Text>Hello world!</Text>\n      </View>\n    );\n  }\n}\n\nexport default HelloWorldApp;\nAppRegistry.registerComponent(\"HelloWorldApp\", () => HelloWorldApp);\n```\n\nå…¶ä¸­ï¼š\n\n- å½“æˆ‘ä»¬å†™ä¸‹ `<Text/>`ï¼Œå¦‚æœå®åœ¨ Android å¹³å°ï¼ŒText View manager ä¼šè°ƒç”¨ `new TextView(getContext())`\n\nåœ¨ Android å¹³å°ï¼ŒView Managers éƒ½æ˜¯ç»§æ‰¿è‡ª `ViewManager` çš„ç±»ï¼Œåœ¨ iOS åˆ™æ˜¯ç»§æ‰¿è‡ª `RCTViewManager`ã€‚\n\n## å¼€å‘æ¨¡å¼ ğŸ”¨\n\nå½“ APP åœ¨ `DEV` æ¨¡å¼è¿è¡Œæ—¶ JavaScript çº¿ç¨‹åœ¨å¼€å‘æœºï¼ˆç”µè„‘ï¼‰ä¸Šè¢«åˆ›å»ºã€‚\n\nå°½ç®¡ JS ä»£ç åœ¨ç”µè„‘ä¸Šè¿è¡Œçš„æ€§èƒ½æ¯”æ‰‹æœºä¸Šé«˜ï¼Œä½†æ˜¯ä½ ä¼šæ³¨æ„åˆ°å®é™…æ€§èƒ½æ¯” bundled æ¨¡å¼æˆ–è€… production æ¨¡å¼è¿˜è¦æ…¢ã€‚\n\nè¿™æ˜¯å› ä¸ºåœ¨ DEVæ¨¡å¼ä¸‹ï¼Œåœ¨è¿è¡Œæ—¶è¦åšè®¸å¤šé¢å¤–å·¥ä½œï¼Œæ¥æä¾›æ›´å¥½çš„è­¦å‘Šä¸é”™è¯¯ä¿¡æ¯ï¼Œä¾‹å¦‚éªŒè¯ propTypes ä»¥åŠå…¶å®ƒçš„æ–­è¨€ã€‚\n\næ­¤å¤–ï¼Œè®¾å¤‡ä¸ JS ä¹‹é—´çš„é€šä¿¡å»¶è¿Ÿä¹Ÿæ˜¯å¯¼è‡´æ…¢çš„åŸå› ã€‚\n\né“¾æ¥ï¼š<https://www.youtube.com/watch?v=8N4f4h6SThc> - RN android architecture\n\n## React Native çš„æ–°æ¶æ„ï¼ˆFabricï¼‰\n\nReact Native å›¢é˜Ÿç›®å‰æ­£åœ¨ä¸º React Native å¼€å‘ä¸€ä¸ªæ–°æ¶æ„ã€‚\n\næ–°æ¶æ„çš„ä»£å·ä¸º Fabricï¼Œå°†ä¼šå…è®¸ React Native ä»¥åŒæ­¥æ–¹å¼æ‰§è¡Œé«˜ä¼˜å…ˆçº§çš„ UI æ›´æ–°ã€‚\n\nè¿™æ„å‘³ç€ UI åœ¨æŸäº›æé™æƒ…å†µï¼ˆEdge Casesï¼‰ä¸‹ä¼šæ›´çµæ•ï¼ˆæ¯”å¦‚æ»šåŠ¨è§†å›¾ï¼‰ã€‚\n\næƒ³è¦äº†è§£ Fabric ä»¥åŠå®ƒåˆ°åº•å¦‚ä½•æå‡ React Native çš„è¯ï¼Œè¯·è§‚çœ‹ Parashuram N åœ¨ React Conf 2018 ä¸Šçš„ç²¾å½©æ¼”è®²ã€‚https://www.youtube.com/watch?v=UcqRXTriUVI"},"path":"post/ReactNativeInternalsmd"}
