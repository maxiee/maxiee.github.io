{"template":"/home/maxiee/Code/Blog/maxiee.github.io/src/pages/post","sharedHashesByProp":{},"data":{"post":{"name":"蜜獾NAS：更换风扇彻底消除噪声","desc":"蜜獾的噪声有些大，更换横益 7025B 电源后噪声下降不明显，发现机箱风扇也是噪声源之一，因此又对风扇进行了更换。在本文中记录了更换风扇过程中的踩坑与心得。感谢 @karminski-牙医 老师指导并推荐风扇，静音效果非常棒，噪声问题彻底解决。","type":"md","link":"mihuan3md","create":"2021-01-24","filename":"mihuan3.md"},"content":"## 前言\n\n蜜獾的噪声有些大，更换横益 7025B 电源后噪声下降不明显，发现机箱风扇也是噪声源之一，因此又对风扇进行了更换。在本文中记录了更换风扇过程中的踩坑与心得。感谢 @karminski-牙医 老师指导并推荐风扇，静音效果非常棒，噪声问题彻底解决。\n\n## 噪声来源\n\n蜜獾的噪声有两处来源：\n\n* 自带的链力电源风扇\n* 两个后机箱风扇\n\n这两处噪声都大，这也是为什么我只更换电源噪声下降不明显的原因。\n\n## 自带风扇\n\n机器自带的是两个无牌的两线扇，风量大，动静也大。\n\n![](image/微信图片_20210123215231.jpg)\n\n风扇的接头是这样的，只有两根电源线：\n\n![](image/微信图片_20210123220748.jpg)\n\n我发现主板上的风扇接口是 4pin 的，支持 pwm 调速。这么说买两个四线 pwm 扇装上，然后将速度调到最低，岂不就解决风扇问题了吗？\n\n## 第一次购买风扇\n\n带着“8cm 四线 pwm”关键字上某宝搜索风扇，因为没什么经验，挑了一个销量还不错，价格也便宜的风扇就下单了。就是这俩：\n\n![](image/微信图片_20210123220542.jpg)\n\n这俩风扇自带的线比较短，于是又上某多多上买了两条风扇延长线：\n\n![](image/微信图片_20210123220653.jpg)\n\n这俩风扇买回来之后翻车了。\n\n首先是这俩虽然是四线扇，但是不支持调速，用 pwmconfig 测试不同 PWM 值，风扇的转速不变，恒定在 1660 转左右。\n\n![](image/微信图片_20210123220952.jpg)\n\n输出不同 pwm 值风扇转速不变，要么风扇有问题，要么主板有问题。\n\n由于不能调速，风扇的噪声还是比较大的，甚至比之前的两线扇还要大。\n\n（其实，这个风扇还有一种转速，在 Linux 硬件监控驱动中，可以将 PWM 风扇改为开环（Open Loop）模式，这种模式下风扇能达到 3500 转，噪声是非常响的，同时风力也极大。）\n\n## 第二次购买风扇\n\n在牙医老师的指导下，我知道原来是我买的风扇电流是 0.35A，对于考虑静音效果的风扇来说电流偏大了。\n\n老师推荐了一款 ARCTIC 0.09A 风扇，即 F8 PWM，电流只有 0.09A：\n\n![](image/微信图片_20210123222311.jpg)\n\n看这包装就比之前买的那俩靠谱。于是赶紧拆机换上。\n\n换上之后，我在 BIOS 里将转速 PWM 设了一个非常小的值，进入系统后检测，转速只有 300 多转：\n\n![](image/屏幕截图2021-01-23222809.png)\n\n转速为图中的 fan1、fan2.。\n\n此时蜜獾整机的噪声变得非常小，非常静音。我把蜜獾摆在桌子上也是非常静音，因为房间里还开着其它几台电脑，蜜獾的声音完全消失在其它电脑的噪声之中。\n\n噪声是一个非常主观的概念，每个人的接受程度是不同的。由于时间匆忙，我也没有购入分贝计进行客观测试，因此都是以我的主观感受为主。不过，我可以肯定的是，之前那套风扇的噪声完全谈不上静音，换了这俩风扇之后已经是非常静音的主机了。\n\n## pwmconfig 和 fancontrol\n\npwmconfig 和 fancontrol 是 lm-sensors 中自带的风扇调速工具。fancontrol 是一个命令，同时也是一个 Systemd 服务，允许用户可以通过配置文件，根据系统温度传感器，控制风扇的调速曲线。\n\npwmconfig  是 fancontrol 的配置工具，用于检测系统中存在的风扇和传感器，并对风扇 PWM-转速的映射关系进行测试。测试完毕后，pwmconfig 会生成 /etc/fancontrol 配置文件，供 fancontrol 读取。\n\nfancontrol 本身是一个 Systemd 服务，服务名称为 fancontrol.service。enable 这个服务后，能够在每次进入系统后，由 Linux 接管风扇的控速逻辑。\n\n## BIOS 风扇 PWM 调速\n\n后来我发现蜜獾的 BIOS 直接支持风扇 PWM 调速，这就省事了。蜜獾 CPU 采用被动散热，两个机箱扇的作用是给硬盘笼散热，硬盘笼本身发热也不厉害，因此锁定最低转速即可。\n\n这也是我目前采用的方式。在风扇 300 转下，硬盘的温度：\n\n![](image/屏幕截图2021-01-23224208.png)\n\n其中 sda 是主板上的系统盘，温度高一些。\n\n其他的硬盘都在硬盘笼中，平时基本不访问，因此以休眠为主。\n\n## it87 内核驱动\n\n通过查看内核信息，发现主板的温控芯片是 IT8728F，这是一款硬件监控芯片，对应的内核驱动在[这里](https://www.kernel.org/doc/html/latest/hwmon/it87.html)。\n\n这个芯片包含 3 个温度传感器，3 个风扇转速传感器，8 个电压传感器，以及相关的报警。尤其是支持当风扇转速低于某一阈值时报警。\n\n风扇速度控制功能仅限于手动 PWM 模式。自动 \"Smart Guardian \"模式的控制处理只适用于旧芯片，但是如果你想使用 \"手动模式\"，只需在 pwmN_enable 中写1。\n\n如果您只能用非常小的 PWM 值来控制风扇速度，请尝试降低 PWM 基本频率(pwm1_freq)。根据风扇的情况，它可能会给你一个更大的控制范围。相同的频率用于驱动所有风扇输出，这就是为什么 pwm2_freq 和 pwm3_freq 是只读的原因。\n\n## 小结\n\n至此就完成了蜜獾更换机箱风扇的实践，大部分实践其实都花在等快递上面。\n\n又一个问题解决了，可以向下一个目标迈进了。"},"path":"post/mihuan3md"}
